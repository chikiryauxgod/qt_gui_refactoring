commit b888f67285ddbb8fa676af6de1a5f692d15993a7
Author:     faweddd <igormaluh010@mail.ru>
AuthorDate: Fri Jan 23 04:03:04 2026 +0500
Commit:     faweddd <igormaluh010@mail.ru>
CommitDate: Fri Jan 23 04:03:04 2026 +0500

    refactor: move classes


FILES:

FILE: src/application/process_manager.py
LANG: py

new file mode 100644
index 0000000..2c4a3e0
--- /dev/null
+++ b/src/application/process_manager.py
@@ -0,0 +1,41 @@
+from src.erosion_worker.erosion_worker import ErosionWorker, ErosionController, GCodeProcessor
+from src.electoerosion import Electroerosion
+from src.log import logger, q
+
+# Process management (SRP)
+class ProcessManager:
+    def __init__(self, hardware_controller, erosion_tab, state_manager):
+        self.hardware = hardware_controller
+        self.erosion_tab = erosion_tab
+        self.state = state_manager
+        self.erosion_worker = None
+
+    def start_erosion_process(self, gcode_points, electrode_diameter, electrode_length, erosion_time, erosion_up_time, erosion_depth, filename, mode):
+        erosion_controller = ErosionController(Electroerosion, filename, logger=logger, speed=10, mode=mode)
+        gcode_processor = GCodeProcessor(gcode_points, erosion_time)
+        self.erosion_worker = ErosionWorker(erosion_controller, gcode_processor)
+        self.erosion_worker.progress_updated.connect(lambda p: self.erosion_tab.progress_bar.setValue(int(p)))
+        self.erosion_worker.time_updated.connect(lambda t: self.erosion_tab.time_label.setText(f"Осталось: {t}"))
+        self.erosion_worker.finished.connect(self.erosion_finished)
+        self.erosion_worker.paused.connect(self.erosion_paused)
+        self.erosion_worker.resumed.connect(self.erosion_resumed)
+        self.erosion_worker.start()
+        self.erosion_tab.set_erosion_worker(self.erosion_worker)
+        self.erosion_tab.update_process_status("ПРОЦЕСС ВЫПОЛНЯЕТСЯ", "#27ae60")
+        logger("Процесс запущен", queue=q)
+
+    def stop_erosion_process(self):
+        if self.erosion_worker and self.erosion_worker.isRunning():
+            self.erosion_worker.stop()
+            self.erosion_worker.wait(2000) or self.erosion_worker.terminate()
+        self.erosion_tab.set_stopped_ui_state()
+        self.erosion_tab.update_process_status("ПРОЦЕСС ОСТАНОВЛЕН", "#e74c3c")
+
+    def erosion_finished(self):
+        self.erosion_tab.update_process_status("ПРОЦЕСС ЗАВЕРШЕН", "#3498db")
+
+    def erosion_paused(self):
+        self.erosion_tab.update_process_status("ПРОЦЕСС НА ПАУЗЕ", "#f39c12")
+
+    def erosion_resumed(self):
+        self.erosion_tab.update_process_status("ПРОЦЕСС ВЫПОЛНЯЕТСЯ", "#27ae60")
\ No newline at end of file


FILE: src/domain/constants.py
LANG: py

new file mode 100644
index 0000000..0e73cca
--- /dev/null
+++ b/src/domain/constants.py
@@ -0,0 +1,6 @@
+X0 = 430.0 
+Y0 = 0.0 
+Z0 = 277.0 
+XS = 0 
+YS = 0 
+ZS = 0
\ No newline at end of file


FILE: src/domain/state_manager.py
LANG: py

new file mode 100644
index 0000000..72c288a
--- /dev/null
+++ b/src/domain/state_manager.py
@@ -0,0 +1,13 @@
+class StateManager:
+    def __init__(self, x0, y0, z0, robot):
+        self.current_x = x0
+        self.current_y = y0
+        self.current_z = z0
+        self.current_joints = [0] * 6
+        self.updating = False
+        self.robot = robot
+
+    def sync_from_robot(self):
+        self.current_x = self.robot.current_x
+        self.current_y = self.robot.current_y
+        self.current_z = self.robot.current_z
\ No newline at end of file


FILE: src/ports/ihardware_controller.py
LANG: py

new file mode 100644
index 0000000..0d6b470
--- /dev/null
+++ b/src/ports/ihardware_controller.py
@@ -0,0 +1,9 @@
+class IHardwareController:
+    def set_coord_pos(self, x, y, z): pass
+    def set_joint_pos(self, joints): pass
+    def set_erosion(self, state): pass
+    def set_water(self, state): pass
+    def pump_control_one(self): pass
+    def pump_control_two(self): pass
+    def set_speed(self, v): pass
+    def emergency_stop(self): pass
\ No newline at end of file


FILE: src/services/hardware_controller.py
LANG: py

new file mode 100644
index 0000000..7cd6152
--- /dev/null
+++ b/src/services/hardware_controller.py
@@ -0,0 +1,43 @@
+# Hardware controller implementation
+from src.ports.ihardware_controller import IHardwareController
+from src.electoerosion import Electroerosion
+from src.robot import Robot
+from src.pico import Pico
+
+class HardwareController(IHardwareController):
+    def __init__(self, erode=None):
+        self.erode = erode or Electroerosion()
+        self.robot = self.erode.robot if self.erode.robot else Robot()
+        self.pico = self.erode.erosion if self.erode.erosion else Pico()
+        self.state_pump_one = False
+        self.state_pump_two = False
+
+    def set_coord_pos(self, x, y, z):
+        self.erode.set_coord_pos(x, y, z)
+        self.robot.current_x = x
+        self.robot.current_y = y
+        self.robot.current_z = z
+
+    def set_joint_pos(self, joints):
+        self.robot.set_joint_pos(joints)
+
+    def set_erosion(self, state):
+        self.pico.erosion(1 if state else 0)
+
+    def set_water(self, state):
+        self.pico.pump_in(1 if state else 0)
+        self.pico.pump_out(1 if state else 0)
+
+    def pump_control_one(self):
+        self.state_pump_one = not self.state_pump_one
+        self.pico.pump_in(1 if self.state_pump_one else 0)
+
+    def pump_control_two(self):
+        self.state_pump_two = not self.state_pump_two
+        self.pico.pump_out(1 if self.state_pump_two else 0)
+
+    def set_speed(self, v):
+        self.robot.set_speed(v)
+
+    def emergency_stop(self):
+        self.robot.emergency_stop()


FILE: src/ui/__init__.py
LANG: py

new file mode 100644
index 0000000..e69de29


FILE: src/ui/main_window.py
LANG: py

new file mode 100644
index 0000000..7051335
--- /dev/null
+++ b/src/ui/main_window.py
@@ -0,0 +1,138 @@
+from src.services.hardware_controller import HardwareController
+from src.domain.state_manager import StateManager
+from src.ui.video_manager import VideoManager
+from src.application.process_manager import ProcessManager
+from PySide6.QtWidgets import QMainWindow, QTabWidget
+from PySide6.QtCore import Slot
+from src.log import logger, q
+from src.ui.ui_manager import UIManager
+from src.services.service_tab import ServiceTab
+from src.erosion_process.erosion_process_tab import ErosionProcessTab
+from src.domain.constants import X0, Y0, Z0
+
+class MainWindow(QMainWindow):
+    def __init__(self):
+        super().__init__()
+        self.hardware = HardwareController()
+        self.state = StateManager(X0, Y0, Z0, self.hardware.robot)
+        self.video_manager = VideoManager()
+        self.process_manager = None
+        self.ui_manager = None
+        self.create_widgets()
+        self.video_manager.start()
+
+    def create_widgets(self):
+        self.setWindowTitle("Управление электроэрозионной установкой")
+        self.setGeometry(100, 100, 1000, 700)
+        self.setMinimumSize(1340, 720)
+        self.setMaximumSize(1920, 1000)
+
+        central_widget = QTabWidget()
+        self.setCentralWidget(central_widget)
+
+        self.erosion_tab = ErosionProcessTab(self, q)
+        central_widget.addTab(self.erosion_tab, "Процесс электроэрозии")
+
+        self.service_tab = ServiceTab(self)
+        central_widget.addTab(self.service_tab, "Сервисное управление")
+
+        self.setStyleSheet("""
+            QMainWindow {
+                background-color: #f0f0f0;
+            }
+            QGroupBox {
+                font-weight: bold;
+                border: 2px solid #cccccc;
+                border-radius: 5px;
+                margin-top: 1ex;
+                padding-top: 10px;
+            }
+            QGroupBox::title {
+                subcontrol-origin: margin;
+                left: 10px;
+                padding: 0 5px 0 5px;
+            }
+        """)
+
+        self.video_manager.video_label = self.erosion_tab.video_label
+        self.process_manager = ProcessManager(self.hardware, self.erosion_tab, self.state)
+        self.ui_manager = UIManager(self.erosion_tab, self.service_tab, self.state)
+
+    @Slot(float, float, float)
+    def set_coord_pos(self, x, y, z):
+        if self.state.updating:
+            return
+        self.state.updating = True
+        try:
+            self.hardware.set_coord_pos(x, y, z)
+            self.state.sync_from_robot()
+            self.ui_manager.sync_coordinates_to_tabs()
+        except Exception as e:
+            logger(f"Couldn't set position: {str(e)}", queue=q)
+        finally:
+            self.state.updating = False
+
+    @Slot(list)
+    def set_joint_pos(self, joints):
+        if self.state.updating:
+            return
+        self.state.updating = True
+        try:
+            self.hardware.set_joint_pos(joints)
+            self.state.current_joints = joints[:6]
+            self.ui_manager.sync_joints_to_tabs()
+        except Exception as e:
+            logger(f"Couldn't set joints: {str(e)}", queue=q)
+        finally:
+            self.state.updating = False
+
+    @Slot(bool)
+    def set_erosion(self, state):
+        self.hardware.set_erosion(state)
+        if hasattr(self.service_tab, 'update_status'):
+            self.service_tab.update_status()
+
+    @Slot(bool)
+    def set_water(self, state):
+        self.hardware.set_water(state)
+        if hasattr(self.service_tab, 'update_status'):
+            self.service_tab.update_status()
+
+    def pump_control_one(self):
+        self.hardware.pump_control_one()
+        if hasattr(self.service_tab, 'update_status'):
+            self.service_tab.update_status()
+
+    def pump_control_two(self):
+        self.hardware.pump_control_two()
+        if hasattr(self.service_tab, 'update_status'):
+            self.service_tab.update_status()
+
+    @Slot(int)
+    def set_speed_w(self, v):
+        self.hardware.set_speed(v)
+
+    @Slot(list, float, float, float, float, float, str, str)
+    def start_erosion_process(self, gcode_points, electrode_diameter, electrode_length, erosion_time, erosion_up_time, erosion_depth, filename, mode):
+        self.process_manager.start_erosion_process(gcode_points, electrode_diameter, electrode_length, erosion_time, erosion_up_time, erosion_depth, filename, mode)
+
+    @Slot()
+    def stop_erosion_process(self):
+        self.process_manager.stop_erosion_process()
+
+    @Slot()
+    def emergency_stop(self):
+        self.hardware.emergency_stop()
+        if hasattr(self.service_tab, 'stop_continuous_move'):
+            self.service_tab.stop_continuous_move()
+
+    def safe_finish(self):
+        self.process_manager.stop_erosion_process()
+        self.hardware.set_erosion(False)
+        self.hardware.set_water(False)
+        self.set_coord_pos(X0, Y0, Z0)
+        self.video_manager.stop()
+
+    def closeEvent(self, event):
+        self.safe_finish()
+        super().closeEvent(event)
\ No newline at end of file


FILE: src/ui/ui_manager.py
LANG: py

new file mode 100644
index 0000000..24b2745
--- /dev/null
+++ b/src/ui/ui_manager.py
@@ -0,0 +1,28 @@
+class UIManager:
+    def __init__(self, erosion_tab, service_tab, state_manager):
+        self.erosion_tab = erosion_tab
+        self.service_tab = service_tab
+        self.state = state_manager
+
+    def sync_coordinates_to_tabs(self):
+        for axis in ['X', 'Y', 'Z']:
+            if axis in self.service_tab.xyz_controls:
+                control = self.service_tab.xyz_controls[axis]
+                value = getattr(self.state, f'current_{axis.lower()}')
+                control['display'].setText(f"{value:.2f}")
+                control['input'].setValue(value)
+        if hasattr(self.service_tab, 'update_xyz_plot'):
+            self.service_tab.update_xyz_plot()
+        self.erosion_tab.x_control.value_label.setText(f"{self.state.current_x:.1f} мм")
+        self.erosion_tab.y_control.value_label.setText(f"{self.state.current_y:.1f} мм")
+        self.erosion_tab.z_control.value_label.setText(f"{self.state.current_z:.1f} мм")
+
+    def sync_joints_to_tabs(self):
+        for i, joint in enumerate(['J0', 'J1', 'J2', 'J3', 'J4', 'J5']):
+            if joint in self.service_tab.joints_controls and i < len(self.state.current_joints):
+                control = self.service_tab.joints_controls[joint]
+                value = self.state.current_joints[i]
+                control['display'].setText(f"{value:.2f}")
+                control['input'].setValue(value)
+        if hasattr(self.service_tab, 'update_joints_plot'):
+            self.service_tab.update_joints_plot()


FILE: src/ui/video_manager.py
LANG: py

new file mode 100644
index 0000000..90cc5ed
--- /dev/null
+++ b/src/ui/video_manager.py
@@ -0,0 +1,23 @@
+from src.VideoStream.VideoStreamThread import VideoStreamThread
+from PySide6.QtCore import Qt, Slot
+from PySide6.QtGui import QImage, QPixmap
+
+# Video management (SRP)
+class VideoManager:
+    def __init__(self, video_label=None):
+        self.video_thread = VideoStreamThread()
+        self.video_label = video_label
+
+    def start(self):
+        self.video_thread.new_frame.connect(self.update_frame)
+        self.video_thread.start()
+
+    def stop(self):
+        self.video_thread.stop()
+
+    @Slot(QImage)
+    def update_frame(self, image):
+        if self.video_label:
+            pixmap = QPixmap.fromImage(image)
+            scaled = pixmap.scaled(self.video_label.size(), Qt.KeepAspectRatio, Qt.SmoothTransformation)
+            self.video_label.setPixmap(scaled)
\ No newline at end of file