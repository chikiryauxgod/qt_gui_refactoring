commit 9a7d27b271304fae17e35b12f536a010a8e7fd3b
Author:     lewace37 <lewace37@yandex.ru>
AuthorDate: Wed Jan 21 23:51:55 2026 +0500
Commit:     lewace37 <lewace37@yandex.ru>
CommitDate: Wed Jan 21 23:51:55 2026 +0500

    chore: fix naming + add scripts


FILES:

FILE: scripts/aggregate_commit.py
LANG: py

new file mode 100644
index 0000000..7f91c40
--- /dev/null
+++ b/scripts/aggregate_commit.py
@@ -0,0 +1,28 @@
+import json
+from statistics import mean
+from pathlib import Path
+
+def aggregate(results: list[dict]) -> dict:
+    scores = {k: [] for k in ["SRP", "OCP", "LSP", "ISP", "DIP"]}
+
+    for r in results:
+        if "error" in r:
+            continue
+        for k in scores:
+            scores[k].append(r[k]["score"])
+
+    return {
+        k: round(mean(v), 2) if v else None
+        for k, v in scores.items()
+    }
+
+def main():
+    for file in Path("results").glob("*.json"):
+        data = json.loads(file.read_text())
+        summary = aggregate(data)
+        file.with_suffix(".summary.json").write_text(
+            json.dumps(summary, indent=2)
+        )
+
+if __name__ == "__main__":
+    main()


FILE: scripts/analyze_all.py
LANG: py

new file mode 100644
index 0000000..93d1cbd
--- /dev/null
+++ b/scripts/analyze_all.py
@@ -0,0 +1,27 @@
+from pathlib import Path
+import json
+from ollama_client import analyze_chunk
+
+OUT = Path("results")
+OUT.mkdir(exist_ok=True)
+
+def main():
+    for commit_dir in Path("commits").iterdir():
+        if not commit_dir.is_dir():
+            continue
+
+        commit_results = []
+
+        for chunk in commit_dir.glob("chunk_*.txt"):
+            try:
+                result = analyze_chunk(chunk.read_text())
+                commit_results.append(result)
+            except Exception as e:
+                commit_results.append({"error": str(e)})
+
+        (OUT / f"{commit_dir.name}.json").write_text(
+            json.dumps(commit_results, indent=2)
+        )
+
+if __name__ == "__main__":
+    main()


FILE: scripts/chunk_commits.py
LANG: py

new file mode 100644
index 0000000..29a1ced
--- /dev/null
+++ b/scripts/chunk_commits.py
@@ -0,0 +1,34 @@
+from pathlib import Path
+
+MAX_CHARS = 6000  
+
+def chunk_commit(text: str) -> list[str]:
+    chunks = []
+    current = []
+
+    for line in text.splitlines():
+        if sum(len(l) for l in current) > MAX_CHARS:
+            chunks.append("\n".join(current))
+            current = []
+
+        current.append(line)
+
+    if current:
+        chunks.append("\n".join(current))
+
+    return chunks
+
+
+def main():
+    for norm_file in Path("commits").glob("*.norm"):
+        chunks = chunk_commit(norm_file.read_text())
+
+        out_dir = norm_file.with_suffix("")
+        out_dir.mkdir(exist_ok=True)
+
+        for i, chunk in enumerate(chunks):
+            (out_dir / f"chunk_{i}.txt").write_text(chunk)
+
+
+if __name__ == "__main__":
+    main()


FILE: scripts/extract_commits.py
LANG: py

new file mode 100644
index 0000000..30ac252
--- /dev/null
+++ b/scripts/extract_commits.py
@@ -0,0 +1,32 @@
+import subprocess
+from pathlib import Path
+
+OUT_DIR = Path("commits")
+OUT_DIR.mkdir(exist_ok=True)
+
+def get_commits():
+    return subprocess.check_output(
+        ["git", "rev-list", "--reverse", "HEAD"],
+        text=True
+    ).splitlines()
+
+def get_commit_diff(commit):
+    return subprocess.check_output(
+        [
+            "git", "show", commit,
+            "--patch",
+            "--no-color",
+            "--format=fuller"
+        ],
+        text=True
+    )
+
+def main():
+    for commit in get_commits():
+        diff = get_commit_diff(commit)
+        (OUT_DIR / f"{commit}.raw").write_text(diff)
+
+if __name__ == "__main__":
+    main()
+
+


FILE: scripts/normalize_commit.py
LANG: py

new file mode 100644
index 0000000..a1c3ac3
--- /dev/null
+++ b/scripts/normalize_commit.py
@@ -0,0 +1,66 @@
+import re
+from pathlib import Path
+
+EXCLUDED_DIRS = (
+    "vendor/",
+    "node_modules/",
+    "dist/",
+    "build/",
+)
+
+MAX_LINES = 300
+
+def detect_language(path):
+    return Path(path).suffix.lstrip(".")
+
+def normalize_commit(raw: str) -> str:
+    lines = raw.splitlines()
+    header, diff = [], []
+    in_diff = False
+
+    for line in lines:
+        if line.startswith("diff --git"):
+            in_diff = True
+        if in_diff:
+            diff.append(line)
+        else:
+            header.append(line)
+
+    result = ["\n".join(header), "\nFILES:"]
+
+    blocks = "\n".join(diff).split("


FILE: scripts/ollama_client.py
LANG: py

new file mode 100644
index 0000000..86342dc
--- /dev/null
+++ b/scripts/ollama_client.py
@@ -0,0 +1,60 @@
+import requests
+import json
+import time
+
+OLLAMA_URL = "http://localhost:11434/api/generate"
+MODEL = "qwen2.5:7b"
+
+SYSTEM_PROMPT = """
+Ты — software architect.
+Оцени изменения кода на соответствие принципам SOLID.
+
+Ответ строго в JSON следующего формата:
+{
+  "solid_score": 0-10,
+  "reason": ""
+}
+
+Никакого текста вне JSON.
+"""
+
+def analyze_chunk(chunk: str) -> dict:
+    try:
+        r = requests.post(
+            OLLAMA_URL,
+            json={
+                "model": MODEL,
+                "prompt": SYSTEM_PROMPT + "\n\n" + chunk,
+                "stream": False,
+                "options": {
+                    "temperature": 0,
+                    "num_predict": 400
+                }
+            },
+            timeout=60
+        )
+    except requests.Timeout:
+        return {"error": "timeout"}
+
+    text = r.json().get("response", "").strip()
+
+    if not text:
+        return {"error": "empty_response"}
+
+    # попытка вытащить JSON даже если модель напортачила
+    start = text.find("{")
+    end = text.rfind("}")
+
+    if start == -1 or end == -1:
+        return {
+            "error": "no_json_found",
+            "raw": text[:500]
+        }
+
+    try:
+        return json.loads(text[start:end + 1])
+    except json.JSONDecodeError as e:
+        return {
+            "error": "invalid_json",
+            "raw": text[start:end + 1][:500]
+        }


FILE: scripts/readme.md
LANG: md

new file mode 100644
index 0000000..b257189
--- /dev/null
+++ b/scripts/readme.md
@@ -0,0 +1,6 @@
+ollama serve
+python extract_commits.py
+python normalize_commit.py